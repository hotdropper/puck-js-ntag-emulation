"use strict";class TagGen{static wipe(t){t.set([4,37,112,217,106,75,104,129],0),t.set([200,72,0,0,225,16,62,0],8),t.set([3,0,254,0,0,0,0,0],16);for(var a=24;a<520;a+=8)t.set([0,0,0,0,0,0,0,0],a);t.set([0,0,0,189,4,0,0,255],520),t.set([0,5,0,0,255,255,255,255],528),t.set([0,0,0,0,250,147,170,224],536),t.set([29,255,135,239,130,91,39,87],544),t.set([42,2,33,140,232,84,211,11],552),t.set([159,145,175,23,5,90,242,63],560),t.set([80,90,226,48,0,4,4,2],568),t.set([1,0,17,3],576),t.set([1,0,0,0],580)}static generate(){var t=new Uint8Array(584);return this.wipe(t),t}static export(t,a){a=a||4,console.log("tag._data = new Uint8Array(584);"),console.log("var s = (i, d) => tag._data.set(d, i * 4);");for(var e=0;e<t._data.length;e+=a){var n=t._data.slice(e,e+a).map(function(t){return(t<16?"0":"")+t.toString(16)}).join(", 0x");console.log("s("+e/4+", [0x"+n+"]);")}console.log("delete s;"),console.log("tag.restart();")}}class LedDancer{static dance(t,a,e,n){t instanceof Pin&&(t=[t]);var s=0,r=0,i=function(){s=Math.abs(s-1),t.forEach(function(t){return t.write(s)}),1===s&&r++,r<e||1===s?setTimeout(i,a):n&&n()};setTimeout(i,a)}}function wireUp(t,a){var e=[LED1,LED2,LED3];function n(t){LedDancer.dance(e,1e3,t,function(){e.forEach(function(t){return t.write(1)}),E.reboot()})}E.on("init",function(){e.forEach(function(t){return t.write(0)})});var s=null,r=null,i=0;(a=a||{})[3]?(a[3]instanceof Array?a[3].push(function(){return n(3)}):a[3]=[a[3],function(){return n(3)}],console.log("Warning: the action(s) on 3 clicks will run just before the puck reboots.")):a[3]=function(){return n(3)};var o=function(){a[i]?a[i]instanceof Array?a[i].forEach(function(t){return t()}):a[i]():LedDancer.dance(e,250,2),r=null,i=0,s=null};setWatch(function(){null!==s&&getTime()-s<t&&clearTimeout(r),i++,s=getTime(),r=setTimeout(o,t)},BTN,{repeat:!0,edge:"rising",debounce:50})}var staticResponses={nak:{invalid_argument:0,invalid_crc:1,auth:4,eeprom_error:5},atqa:new Uint8Array([0,68]),sak:0,ack:10};function write(t,a){return t._pages[a[1]]?(t._pages[a[1]].set(new Uint8Array(a,2,4),0),t._dataChanged?t._staticResponses.ack:(t._dataChanged=!0,LED3.write(1),t._staticResponses.ack)):t._staticResponses.nak.invalid_argument}var compatWriteAddr=null,compatWriteMsg=new Uint8Array(18);function compatWrite(t,a){return compatWriteAddr?(t._page[compatWriteMsg].set(new Uint8Array(a,0,4),0),compatWriteAddr=null,t._staticResponses.ack):t._pages[a[1]]?(compatWriteAddr=a[1],t._staticResponses.ack):t._staticResponses.nak.invalid_argument}function read(t,a){if(t._pages[a[1]]){var e=new Uint8Array(16);return e.set(t._pages[a[1]]),e}return t._staticResponses.nak.invalid_argument}function readFast(t,a){return t._pages[a[1]]&&t._pages[a[2]]?new Uint8Array(t._data.buffer,4*a[1],4*(a[2]-a[1]+1)):t._staticResponses.nak.invalid_argument}function readCounter(t,a){return t._pages[a[1]]?t._pages[a[1]]:t._staticResponses.nak.invalid_argument}function readVersion(t){return t._responses.version}function readSignature(t){return t._responses.signature}function auth(t,a){return new Uint8Array(a,1,4)===tag._info.password?t._responses.pack:t._staticResponses.nak.auth}function reload(t){t.stop(),t.start()}function keepAlive(){}function wupa(){}compatWriteMsg[0]=162;var commands={48:read,58:readFast,162:write,160:compatWrite,96:readVersion,27:auth,60:readSignature,57:readCounter,136:reload,26:keepAlive,147:keepAlive,82:wupa};class NFCTag{constructor(t,a){this.led=t,this._data=a,this._info={},this._dataChanged=!1,this._responses={},this._staticResponses=staticResponses,this._initCard()}start(){NRF.nfcStart(this._info.uid)}stop(){NRF.nfcStop()}restart(){this.stop(),this._initCard(),this.start()}activate(){this.led.write(1)}deactivate(){this.led.write(0)}_initCard(){this._dataChanged=!1,LED3.write(0),this._info.uid=new Uint8Array([this._data[0],this._data[1],this._data[2],this._data[4],this._data[5],this._data[6],this._data[7]]);this._info.password=new Uint8Array(this._data.buffer,532,4);this._responses.pack=new Uint8Array(this._data.buffer,536,2),this._data.length>540&&(this._responses.signature=new Uint8Array(this._data.buffer,540,32)),this._data.length>572?this._responses.version=new Uint8Array(this._data.buffer,572,8):this._responses.version=new Uint8Array([0,4,4,2,1,0,17,3]),this._fixUid(),this._pages=[];for(var t=0;t<135;t++){var a=16;t>129&&(a-=4*(t-129)),this._pages[t]=a<4?new Uint8Array(4):new Uint8Array(this._data.buffer,4*t,a)}this._pages[240]=new Uint8Array(this._data.buffer,532,4),this._pages[241]=new Uint8Array(this._data.buffer,536,2),this._pages[242]=new Uint8Array(this._data.buffer,540,4),this._pages[243]=new Uint8Array(this._data.buffer,544,4),this._pages[244]=new Uint8Array(this._data.buffer,548,4),this._pages[245]=new Uint8Array(this._data.buffer,552,4),this._pages[246]=new Uint8Array(this._data.buffer,556,4),this._pages[247]=new Uint8Array(this._data.buffer,560,4),this._pages[248]=new Uint8Array(this._data.buffer,564,4),this._pages[249]=new Uint8Array(this._data.buffer,568,4),this._pages[250]=new Uint8Array(this._data.buffer,572,4),this._pages[251]=new Uint8Array(this._data.buffer,576,4),this._pages[252]=new Uint8Array(this._data.buffer,580,4)}_fixUid(){var t=this._data[0]^this._data[1]^this._data[2]^136,a=this._data[4]^this._data[5]^this._data[6]^this._data[7];return(this._data[3]!==t||this._data[8]!==a)&&(this._data[3]=t,this._data[8]=a,console.log("Fixed bad bcc"),!0)}}var tagData=TagGen.generate(),tag=new NFCTag(LED1,tagData),oldNfcSend=NRF.nfcSend;function processRx(t){try{compatWriteAddr?NRF.nfcSend(commands[160](tag,t)):t&&commands[t[0]]?NRF.nfcSend(commands[t[0]](tag,t)):NRF.nfcSend(staticResponses.nak.invalid_argument)}catch(t){}}NRF.nfcSend=function(t){return oldNfcSend(t)},NRF.on("NFCrx",function(t){processRx(t)}),tag.start(),wireUp(1e3,{1:function(){tag.stop(),LED2.write(1),tag._initCard(),setTimeout(function(){tag.start(),LED2.write(0)},200)},3:function(){return console.log("Rebooting...")}});