"use strict";String.prototype.padStart||(String.prototype.padStart=function(t,e){return t>>=0,e=String(void 0!==e?e:" "),this.length>t?String(this):((t-=this.length)>e.length&&(e+=e.repeat(t/e.length)),e.slice(0,t)+String(this))}),String.prototype.padEnd||(String.prototype.padEnd=function(t,e){return t>>=0,e=String(void 0!==e?e:" "),this.length>t?String(this):((t-=this.length)>e.length&&(e+=e.repeat(t/e.length)),String(this)+e.slice(0,t))});class IdleDetector{constructor(t,e,a){this.name=t,this.interval=e/2,this.doAction=a,this.timeoutRef=null,this.ticks=0,this.lastTick=null,this.actionTick=0,this.enabled=!1}enable(t){t&&(this.interval=t),this.enabled=!0,this.registerTimeout()}disable(){this.enabled=!1,this.timeoutRef&&(clearTimeout(this.timeoutRef),this.timeoutRef=null)}tick(){this.enabled&&this.ticks++}monitor(){return this.lastTick!==this.ticks?(this.lastTick=this.ticks,this.registerTimeout()):(this.ticks!==this.actionTick&&(this.actionTick=this.ticks,this.doAction()),this.registerTimeout())}registerTimeout(){var t=this;this.timeoutRef||(this.timeoutRef=setTimeout(function(){t.timeoutRef=null,t.monitor()},this.interval))}}var MAX_ELEMENTS_PER_ROW=16,TABLE_PAD_MIDDLE=3*MAX_ELEMENTS_PER_ROW+2,TABLE_PAD_END=15,annotations={rx:{162:function(t){return"WRITE("+t[1].toString("16").padStart(2,"0")+")"},160:function(t){return"COMP_WRITE("+t[1].toString("16").padStart(2,"0")+")"},27:function(){return"PWD_AUTH"},48:function(t){return"READ("+t[1].toString("16").padStart(2,"0")+")"},60:function(){return"READ_SIG"},96:function(){return"GET_VERSION"},57:function(t){return"READ_CNT("+t[1].toString("16").padStart(2,"0")+")"},58:function(t){return"FAST_READ("+t[1].toString("16").padStart(2,"0")+" => "+t[2].toString("16").padStart(2,"0")+")"}},tx:{0:function(t){return 0===t.length?"NAK_INVALID_ARG":null},1:function(t){return 0===t.length?"NAK_CRC":null},4:function(t){return 0===t.length?"NAK_AUTH_LOCKOUT":null},5:function(t){return 0===t.length?"NAK_EEPROM_ERROR":null},10:function(t){return 0===t.length?"ACK":null}}};class NFCLogger{static attach(){!0!==NFCLogger.attached&&(NFCLogger.attached=!0,NFCLogger.heldResponses=[],NRF.nfcSend=function(t){NFCLogger.originalNfcSend.call(NRF,t),!1!==NFCLogger.tracking&&(t instanceof Uint8Array?NFCLogger.heldResponses.push({type:"tx",data:t}):t instanceof Number?NFCLogger.heldResponses.push({type:"tx",data:new Uint8Array([t])}):NFCLogger.heldResponses.push({type:"tx",data:new Uint8Array(0)}),NFCLogger.idleDetector.tick())},NRF.on("NFCrx",function(t){return NFCLogger._receive(t)}))}static _receive(t){!1!==NFCLogger.tracking&&(NFCLogger.log.push({type:"rx",data:new Uint8Array(t)}),NFCLogger.heldResponses.length>0&&NFCLogger.log.push(NFCLogger.heldResponses.shift()),NFCLogger.idleDetector.tick())}static stop(){NFCLogger.tracking=!1,NFCLogger.idleDetector.disable()}static start(t){NFCLogger.idleDetector.enable(t||5e3),NFCLogger.tracking=!0}static _monitor(){NFCLogger._printLogHeading(),NFCLogger.log.forEach(function(t){NFCLogger._printLogEntry(t)}),NFCLogger.log=[],NFCLogger.lastCount=NFCLogger.count}static _printLogHeading(){var t=" Src | ";t+=" Data ".padEnd(TABLE_PAD_MIDDLE," ")+" |",t+=" Annotation",console.log(t),console.log("-".repeat(5)+"|-"+"-".repeat(TABLE_PAD_MIDDLE)+"-|"+"-".repeat(TABLE_PAD_END))}static _printLogEntry(t){t.data||(t.data=new Uint8Array([]));for(var e=0;e<t.data.length;e+=MAX_ELEMENTS_PER_ROW){var a=" "+(0===e?"rx"===t.type?"Rdr":"Tag":"   ")+" | ",n=[],i=e+MAX_ELEMENTS_PER_ROW;i=i>t.data.length?t.data.length-e:MAX_ELEMENTS_PER_ROW,n=new Uint8Array(t.data.buffer,t.data.byteOffset+e,i);var r=" ";n.forEach(function(t){r+=t.toString(16).toUpperCase().padStart(2,"0")+" "}),r=r.padEnd(TABLE_PAD_MIDDLE)+" |";var s=annotations[t.type][t.data[0]]?annotations[t.type][t.data[0]](t.data):null;a+=0===e&&s?r+" "+s:r,console.log(a)}}}NFCLogger.originalNfcSend=NRF.nfcSend,NFCLogger.idleDetector=new IdleDetector("log watch",5e3,function(){NFCLogger._monitor()}),NFCLogger.tracking=!1,NFCLogger.log=[],NFCLogger.heldResponses=[];class Debugger{static debug(t){this.isEnabled()&&t()}static isEnabled(){return!0===this.enabled}static enable(){this.enabled=!0}static disable(){this.enabled=!1}static exportTag(t,e){e=e||16,console.log("tag._data = new Uint8Array(584);"),console.log("var s = (i, d) => tag._data.set(d, i * 4);");for(var a=0;a<t._data.length;a+=e){var n=t._data.slice(a,a+e).map(function(t){return t.toString(16).padStart(2,"0")}).join(", 0x");console.log("s("+a/4+", [0x"+n+"]);")}console.log("delete s;"),console.log("tag.restart();")}}class TagGen{static wipeData(t){t.set([4,37,112,217,106,75,104,129],0),t.set([200,72,0,0,225,16,62,0],8),t.set([3,0,254,0,0,0,0,0],16);for(var e=24;e<520;e+=8)t.set([0,0,0,0,0,0,0,0],e);t.set([0,0,0,189,4,0,0,255],520),t.set([0,5,0,0,255,255,255,255],528),t.set([0,0,0,0,250,147,170,224],536),t.set([29,255,135,239,130,91,39,87],544),t.set([42,2,33,140,232,84,211,11],552),t.set([159,145,175,23,5,90,242,63],560),t.set([80,90,226,48,0,4,4,2],568),t.set([1,0,17,3],576),t.set([1,0,0,0],580)}static generateData(){var t=new Uint8Array(584);return this.wipeData(t),t}}var staticResponses={nak:{invalid_argument:0,invalid_crc:1,auth:4,eeprom_error:5},atqa:new Uint8Array([0,68]),sak:0,ack:10};function write(t,e){return t._pages[e[1]]?(t._pages[e[1]].set(new Uint8Array(e,2,4),0),t._dataChanged?t._staticResponses.ack:(t._dataChanged=!0,LED3.write(1),t._staticResponses.ack)):t._staticResponses.nak.invalid_argument}var compatWriteAddr=null,compatWriteMsg=new Uint8Array(18);function compatWrite(t,e){return compatWriteAddr?(t._page[compatWriteMsg].set(new Uint8Array(e,0,4),0),compatWriteAddr=null,t._staticResponses.ack):t._pages[e[1]]?(compatWriteAddr=e[1],t._staticResponses.ack):t._staticResponses.nak.invalid_argument}function read(t,e){if(t._pages[e[1]]){var a=new Uint8Array(16);return a.set(t._pages[e[1]]),a}return t._staticResponses.nak.invalid_argument}function readFast(t,e){return t._pages[e[1]]&&t._pages[e[2]]?new Uint8Array(t._data.buffer,4*e[1],4*(e[2]-e[1]+1)):t._staticResponses.nak.invalid_argument}function readCounter(t,e){return t._pages[e[1]]?t._pages[e[1]]:t._staticResponses.nak.invalid_argument}function readVersion(t){return t._responses.version}function readSignature(t){return t._responses.signature}function auth(t,e){return new Uint8Array(e,1,4)===tag._info.password?t._responses.pack:t._staticResponses.nak.auth}function reload(t){t.stop(),t.start()}function keepAlive(){}function wupa(){}compatWriteMsg[0]=162;var commands={48:read,58:readFast,162:write,160:compatWrite,96:readVersion,27:auth,60:readSignature,57:readCounter,136:reload,26:keepAlive,147:keepAlive,82:wupa};class NFCTag{constructor(t,e){this.led=t,this._data=e,this._info={},this._dataChanged=!1,this._responses={},this._staticResponses=staticResponses,this._initCard()}start(){NRF.nfcStart(this._info.uid)}stop(){NRF.nfcStop()}restart(){this.stop(),this._initCard(),this.start()}activate(){this.led.write(1)}deactivate(){this.led.write(0)}_initCard(){var t=this;this._dataChanged=!1,LED3.write(0),this._info.uid=new Uint8Array([this._data[0],this._data[1],this._data[2],this._data[4],this._data[5],this._data[6],this._data[7]]);this._info.password=new Uint8Array(this._data.buffer,532,4);this._responses.pack=new Uint8Array(this._data.buffer,536,2),this._data.length>540&&(this._responses.signature=new Uint8Array(this._data.buffer,540,32)),this._data.length>572?this._responses.version=new Uint8Array(this._data.buffer,572,8):this._responses.version=new Uint8Array([0,4,4,2,1,0,17,3]),this._fixUid(),this._pages=[];for(var e=0;e<135;e++){var a=16;e>129&&(a-=4*(e-129)),this._pages[e]=a<4?new Uint8Array(4):new Uint8Array(this._data.buffer,4*e,a)}this._pages[240]=new Uint8Array(this._data.buffer,532,4),this._pages[241]=new Uint8Array(this._data.buffer,536,2),this._pages[242]=new Uint8Array(this._data.buffer,540,4),this._pages[243]=new Uint8Array(this._data.buffer,544,4),this._pages[244]=new Uint8Array(this._data.buffer,548,4),this._pages[245]=new Uint8Array(this._data.buffer,552,4),this._pages[246]=new Uint8Array(this._data.buffer,556,4),this._pages[247]=new Uint8Array(this._data.buffer,560,4),this._pages[248]=new Uint8Array(this._data.buffer,564,4),this._pages[249]=new Uint8Array(this._data.buffer,568,4),this._pages[250]=new Uint8Array(this._data.buffer,572,4),this._pages[251]=new Uint8Array(this._data.buffer,576,4),this._pages[252]=new Uint8Array(this._data.buffer,580,4),Debugger.debug(function(){console.log("password",t._info.password),console.log("pack",t._responses.pack),console.log("signature",t._responses.signature),console.log("version",t._responses.version)})}_fixUid(){var t=this,e=this._data[0]^this._data[1]^this._data[2]^136,a=this._data[4]^this._data[5]^this._data[6]^this._data[7];return Debugger.debug(function(){for(var n="",i=0;i<9;i++)n+=t._data[i].toString(16)+" ";console.log(n),console.log(e.toString(16)+" "+a.toString(16))}),(this._data[3]!==e||this._data[8]!==a)&&(this._data[3]=e,this._data[8]=a,console.log("Fixed bad bcc"),!0)}}var tagData=TagGen.generateData(),tag=new NFCTag(LED1,tagData);function processRx(t){try{compatWriteAddr?NRF.nfcSend(commands[160](tag,t)):t&&commands[t[0]]?NRF.nfcSend(commands[t[0]](tag,t)):NRF.nfcSend(staticResponses.nak.invalid_argument)}catch(t){}}NRF.on("NFCrx",function(t){processRx(t)}),tag.start(),NFCLogger.stop(),setWatch(function(){tag.stop(),LED2.write(1),tag._initCard(),setTimeout(function(){tag.start(),LED2.write(0)},200)},BTN,{repeat:!0,edge:"rising",debounce:50});