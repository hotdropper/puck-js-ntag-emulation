function g(a,b,c){if(a<b||a>c)throw"Out of range";}function e(a,d,c){a=a||{};a.addr=a.addr||b.I2C_ADDR_PRIMARY;this.w=c;this.r=d;if(this.r(b.CHIP_ID_ADDR,1)!=b.CHIP_ID)throw Error("BME680 not found");var f=this;f.set_sensor_mode(b.SLEEP_MODE);f.soft_reset(function(){f.get_calib_data();f.set_sensor_settings({os_hum:b.OS_2X,os_pres:b.OS_4X,os_temp:b.OS_8X,filter:b.FILTER_SIZE_3,run_gas:b.ENABLE_GAS_MEAS,heatr_temp:320,heatr_dur:150,heatr_ctrl:b.ENABLE_HEATER,nb_conv:0});f.set_sensor_mode(b.FORCED_MODE)})}
var b={POLL_PERIOD_MS:10,I2C_ADDR_PRIMARY:118,CHIP_ID:97,COEFF_SIZE:41,COEFF_ADDR1_LEN:25,COEFF_ADDR2_LEN:16,FIELD_LENGTH:15,SOFT_RESET_CMD:182,ADDR_RES_HEAT_VAL_ADDR:0,ADDR_RES_HEAT_RANGE_ADDR:2,ADDR_RANGE_SW_ERR_ADDR:4,FIELD0_ADDR:29,RES_HEAT0_ADDR:90,GAS_WAIT0_ADDR:100,CONF_HEAT_CTRL_ADDR:112,CONF_ODR_RUN_GAS_NBC_ADDR:113,CONF_OS_H_ADDR:114,CONF_T_P_MODE_ADDR:116,CONF_ODR_FILT_ADDR:117,COEFF_ADDR1:137,COEFF_ADDR2:225,CHIP_ID_ADDR:208,SOFT_RESET_ADDR:224,ENABLE_HEATER:0,DISABLE_HEATER:1,ENABLE_GAS_MEAS:1,
OS_NONE:0,OS_2X:2,OS_4X:3,OS_8X:4,OS_16X:5,FILTER_SIZE_0:0,FILTER_SIZE_3:2,FILTER_SIZE_127:7,SLEEP_MODE:0,FORCED_MODE:1,RESET_PERIOD:10,HUM_REG_SHIFT_VAL:4,RUN_GAS_DISABLE:0,RUN_GAS_ENABLE:1,NBCONV_MIN:0,NBCONV_MAX:9,FILTER_POS:2,OST_POS:5,OSP_POS:2,HCTRL_POS:3,RUN_GAS_POS:4};e.prototype.soft_reset=function(a){this.w(b.SOFT_RESET_ADDR,b.SOFT_RESET_CMD);a&&setTimeout(a,b.RESET_PERIOD)};e.prototype.get_calib_data=function(){var a=new Uint8Array(b.COEFF_ADDR1_LEN+b.COEFF_ADDR2_LEN);a.set(this.r(b.COEFF_ADDR1,
b.COEFF_ADDR1_LEN));a.set(this.r(b.COEFF_ADDR2,b.COEFF_ADDR2_LEN),b.COEFF_ADDR1_LEN);a=new DataView(a.buffer);this.cal={};this.cal.par_t=[a.getUint16(33,!0),a.getInt16(1,!0),a.getInt8(3)];this.cal.par_p=[a.getUint16(5,!0),a.getInt16(7,!0),a.getInt8(9),a.getInt16(11,!0),a.getInt16(13,!0),a.getInt8(16),a.getInt8(15),a.getInt16(19,!0),a.getInt16(21,!0),a.getUint8(23)];this.cal.par_h=[a.getUint8(27)<<b.HUM_REG_SHIFT_VAL|a.getUint8(26)&15,a.getUint8(25)<<b.HUM_REG_SHIFT_VAL|a.getUint8(26)>>b.HUM_REG_SHIFT_VAL,
a.getInt8(28),a.getInt8(29),a.getInt8(30),a.getUint8(31),a.getInt8(32)];this.cal.par_gh=[a.getInt8(37),a.getInt16(35,!0),a.getInt8(38)];this.cal.res_heat_range=(this.r(b.ADDR_RES_HEAT_RANGE_ADDR,1)[0]&48)/16;this.cal.res_heat_val=this.r(b.ADDR_RES_HEAT_VAL_ADDR,1)[0];this.cal.range_sw_err=(this.r(b.ADDR_RANGE_SW_ERR_ADDR,1)[0]&240)/16};e.prototype.set_sensor_mode=function(a){this.power_mode=a;do{var d=this.r(b.CONF_T_P_MODE_ADDR,1);var c=d&3;c!=b.SLEEP_MODE&&(d&=-4,this.w(b.CONF_T_P_MODE_ADDR,d))}while(c!=
b.SLEEP_MODE);a!=b.SLEEP_MODE&&this.w(b.CONF_T_P_MODE_ADDR,d&-4|a&3)};e.prototype.set_sensor_settings=function(a){var d=this.power_mode;this.set_sensor_mode(b.SLEEP_MODE);if(void 0!==a.filter){g(a.filter,b.FILTER_SIZE_0,b.FILTER_SIZE_127);var c=this.r(b.CONF_ODR_FILT_ADDR,1)[0];c=c&-29|a.filter<<b.FILTER_POS;this.w(b.CONF_ODR_FILT_ADDR,c)}void 0!==a.heatr_ctrl&&(g(a.heatr_ctrl,b.ENABLE_HEATER,b.DISABLE_HEATER),c=this.r(b.CONF_HEAT_CTRL_ADDR,1)[0],c=c&-9|a.heatr_ctrl<<b.HCTRL_POS,this.w(b.CONF_HEAT_CTRL_ADDR,
c));if(void 0!==a.os_temp||void 0!==a.os_pres)c=this.r(b.CONF_T_P_MODE_ADDR,1)[0],void 0!==a.os_temp&&(g(a.os_temp,b.OS_NONE,b.OS_16X),c=c&-225|a.os_temp<<b.OST_POS),void 0!==a.os_pres&&(c=c&-29|a.os_pres<<b.OSP_POS),this.w(b.CONF_T_P_MODE_ADDR,c);void 0!==a.os_hum&&(g(a.os_hum,b.OS_NONE,b.OS_16X),c=this.r(b.CONF_OS_H_ADDR,1)[0],c=c&-8|a.os_hum&7,this.w(b.CONF_OS_H_ADDR,c));if(void 0!==a.run_gas||void 0!==a.nb_conv)c=this.r(b.CONF_ODR_RUN_GAS_NBC_ADDR,1)[0],void 0!==a.run_gas&&(g(a.run_gas,b.RUN_GAS_DISABLE,
b.RUN_GAS_ENABLE),c=c&-17|a.run_gas<<b.RUN_GAS_POS),void 0!==a.nb_conv&&(g(a.nb_conv,b.NBCONV_MIN,b.NBCONV_MAX),c=c&-16|a.nb_conv&15),this.w(b.CONF_ODR_RUN_GAS_NBC_ADDR,c);this.set_heating_settings(a.heatr_temp,a.heatr_dur,a.nb_conv);this.set_sensor_mode(d)};e.prototype.set_heating_settings=function(a,d,c){a="undefined"===typeof a?320:a;d="undefined"===typeof d?150:d;c="undefined"===typeof c?0:c;if(void 0!==c){g(c,b.NBCONV_MIN,b.NBCONV_MAX);var f=this.r(b.CONF_ODR_RUN_GAS_NBC_ADDR,1)[0];this.w(b.CONF_ODR_RUN_GAS_NBC_ADDR,
f&-16|c&15)}void 0!==a&&(g(a,200,400),f=this.calc_heater_resistance(a),this.w(b.RES_HEAT0_ADDR+c,f));void 0!==d&&(g(d,0,4032),f=this.calc_heater_duration(d),this.w(b.GAS_WAIT0_ADDR+c,f))};e.prototype.get_profile_dur=function(a){var b=[0,1,2,4,8,16];var c=b[a.os_temp];c+=b[a.os_pres];c+=b[a.os_hum];c=1963*c+4293;c+=500;c/=1E3;c+=1;a.run_gas&&(c+=a.heatr_dur);return c};e.prototype.get_sensor_data=function(){var a=this.r(b.FIELD0_ADDR,b.FIELD_LENGTH);this.status=a[0]&128;this.gas_index=a[0]&15;this.meas_index=
a[1];var d=a[2]<<12|a[3]<<4|a[4]>>4,c=a[5]<<12|a[6]<<4|a[7]>>4,f=a[8]<<8|a[9],e=a[13]<<2|a[14]>>6,g=a[14]&15;this.status|=a[14]&32;this.status|=a[14]&16;this.ambient_temperature=this.calc_temperature(c)/100;return{"new":!!(this.status&128),temperature:this.ambient_temperature,pressure:this.calc_pressure(d)/100,humidity:this.calc_humidity(f)/1E3,gas_resistance:this.calc_gas_resistance(e,g)}};e.prototype.perform_measurement=function(){this.set_sensor_mode(b.FORCED_MODE)};e.prototype.calc_temperature=
function(a){a=a/8-2*this.cal.par_t[0];this.cal.t_fine=a*this.cal.par_t[1]/2048+a*a/16384*16*this.cal.par_t[2]/16384;return(5*this.cal.t_fine+128)/256};e.prototype.calc_pressure=function(a){var b=(this.cal.t_fine>>1)-64E3;var c=((b>>2)*(b>>2)>>11)*this.cal.par_p[5]>>2;c+=b*this.cal.par_p[4]<<1;c=(c>>2)+(this.cal.par_p[3]<<16);b=(((b>>2)*(b>>2)>>13)*(this.cal.par_p[2]<<5)>>3)+(this.cal.par_p[1]*b>>1);b=(32768+(b>>18))*this.cal.par_p[0]>>15;a=3125*(1048576-a-(c>>12));a=-2147483648<=a?a/b<<1:(a<<1)/b;
b=this.cal.par_p[8]*((a>>3)*(a>>3)>>13)>>12;c=(a>>2)*this.cal.par_p[7]>>13;return a+=b+c+((a>>8)*(a>>8)*(a>>8)*this.cal.par_p[9]>>17)+(this.cal.par_p[6]<<7)>>4};e.prototype.calc_humidity=function(a){var b=5*this.cal.t_fine+128>>8;a=(a-16*this.cal.par_h[0]-(b*this.cal.par_h[2]/100>>1))*(this.cal.par_h[1]*(b*this.cal.par_h[3]/100+(b*this.cal.par_h[4]/100*b>>6)/100+16384)>>10);var c=this.cal.par_h[5]<<7;c=c+b*this.cal.par_h[6]/100>>4;b=1E3*(a+(c*((a>>14)*(a>>14)>>10)>>1)>>10)>>12;1E5<b?b=1E5:0>b&&(b=
0);return b};e.prototype.calc_gas_resistance=function(a,b){var c=(1340+5*this.cal.range_sw_err)*[2147483647,2147483647,2147483647,2147483647,2147483647,2126008810,2147483647,2130303777,2147483647,2147483647,2143188679,2136746228,2147483647,2126008810,2147483647,2147483647][b]/65536;var d=32768*a-16777216+c;return([4096E6,2048E6,1024E6,512E6,255744255,127110228,64E6,32258064,16016016,8E6,4E6,2E6,1E6,5E5,25E4,125E3][b]*c/512+d/2)/d};e.prototype.calc_heater_resistance=function(a){a=Math.min(Math.max(a,
200),400);void 0===this.ambient_temperature&&(this.ambient_temperature=22);return(34*((this.ambient_temperature*this.cal.par_gh[2]/1E3*256+((this.cal.par_gh[1]+154009)*a*5/100+3276800)/10*(this.cal.par_gh[0]+784)/2)/(this.cal.res_heat_range+4)/(131*this.cal.res_heat_val+65536)-250)+50)/100};e.prototype.calc_heater_duration=function(a){if(4032>a){for(var b=0;63<a;)a/=4,b+=1;return Math.floor(a+64*b)}return 255};exports.BME680=e;exports.connectI2C=function(a,d){var c=d&&d.addr||b.I2C_ADDR_PRIMARY;return new e(d,
function(b,d){a.writeTo(c,b);return a.readFrom(c,d)},function(b,d){a.writeTo(c,[b,d])})};exports.connectSPI=function(a,b,c){return new e(c,function(c,d){return a.send([c|128,new Uint8Array(d)],b).slice(1)},function(c,d){a.write(c&127,d,b)})}