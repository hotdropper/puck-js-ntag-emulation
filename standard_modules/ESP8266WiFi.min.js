function m(a){var c=a.indexOf(":");if(0>c)return a;var b=a.substring(5,c).split(",");h=b[0];b[1]|=0;var g=a.length-(c+1);if(g>=b[1])return f[b[0]]+=a.substr(c+1,b[1]),a.substr(c+b[1]+1);f[b[0]]+=a.substr(c+1,g);d.getData(b[1]-g,function(a){f[b[0]]+=a});return""}var d,e=[],f=["","","","",""],h=0,l=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],n={create:function(a,c){if(void 0===a)return b=5,e[b]="Wait",f[b]="",d.cmd("AT+CIPSERVER=1,"+c+"\r\n",1E4,function(a){if("OK"==a)e[b]=!0;else throw e[b]=
void 0,Error("CIPSERVER failed");}),5;for(var b=0;void 0!==e[b];)b++;if(5<=b)throw Error("No free sockets");e[b]="Wait";f[b]="";d.cmd("AT+CIPSTART="+b+',"TCP",'+JSON.stringify(a)+","+c+"\r\n",1E4,function(a){"OK"==a?d.registerLine("Linked",function(){d.unregisterLine("Linked");e[b]=!0}):e[b]=void 0});return b},close:function(a){"Wait"==e[a]?e[a]="WaitClose":(h=a,d.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(){e[a]=void 0}))},accept:function(){for(var a=0;5>a;a++)if(f[a]&&void 0===
e[a])return e[a]=!0,a;return-1},recv:function(a,c){if(f[a]){if(f[a].length>c){var b=f[a].substr(0,c);f[a]=f[a].substr(c)}else b=f[a],f[a]="";return b}return e[a]?"":-1},send:function(a,c){if(d.isBusy()||"Wait"==e[a])return 0;if(!e[a])return-1;d.register("> ",function(){d.unregister("> ");d.write(c);return""});e[a]="Wait";h=a;d.cmd("AT+CIPSEND="+a+","+c.length+"\r\n",1E4,function(b){"SEND OK"==b?("WaitClose"==e[a]&&n.close(a),e[a]=!0):(e[a]=void 0,d.unregister("> "))});return c.length}},k={ipdHandler:m,
debug:function(){return{socks:e,sockData:f}},init:function(a){d.cmd("ATE0\r\n",1E3,function g(b){if("ATE0"==b)return g;"OK"==b?d.cmd("AT+CIPMUX=1\r\n",1E3,function(b){"OK"!=b?a("CIPMUX failed: "+b):a(null)}):a("ATE0 failed: "+b)})},reset:function(a){d.cmd("\r\nAT+RST\r\n",1E4,function g(b){if("ready"==b)setTimeout(function(){k.init(a)},1E3);else if(void 0===b)a("No 'ready' after AT+RST");else return g})},getVersion:function(a){d.cmd("AT+GMR\r\n",1E3,function(c){a(null,c)})},connect:function(a,c,b){d.cmd("AT+CWMODE=1\r\n",
1E3,function(g){"no change"!=g&&"OK"!=g?b("CWMODE failed: "+g):d.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(c)+"\r\n",2E4,function(a){"OK"!=a?b("WiFi connect failed: "+a):b(null)})})},getAPs:function(a){var c=[];d.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");c.push({ssid:JSON.parse(a[1]),enc:l[a[0]],signal:parseInt(a[2]),mac:JSON.parse(a[3])})},function(){a(null,c)})},getConnectedAP:function(a){var c;d.cmdReg("AT+CWJAP?\r\n",1E3,"+CWJAP:",function(a){c=JSON.parse(a.slice(7))},
function(){a(null,c)})},createAP:function(a,c,b,g,e){d.cmd("AT+CWMODE=2\r\n",1E3,function(f){"no change"!=f&&"OK"!=f&&e("CWMODE failed: "+f);f=g?l.indexOf(g):0;0>f?e("Encryption type "+g+" not known - "+l):d.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(c)+","+b+","+f+"\r\n",5E3,function(a){"OK"!=a?e("CWSAP failed: "+a):e(null)})})},getConnectedDevices:function(a){var c=[];this.at.cmd("AT+CWLIF\r\n",1E3,function p(d){if("OK"==d)a(null,c);else if(void 0===d||"ERROR"==d)a("Error");else return d=
d.split(","),c.push({ip:d[0],mac:d[1]}),p})},getIP:function(a){d.cmd("AT+CIFSR\r\n",1E3,function(c){return function(b){return"OK"!=b?a("CIFSR failed: "+b):a(null,c)}})}};exports.connect=function(a,c){k.at=d=require("AT").connect(a);require("NetworkJS").create(n);d.register("+IPD",m);d.registerLine("Unlink",function(){e[h]=void 0});k.reset(c);return k}