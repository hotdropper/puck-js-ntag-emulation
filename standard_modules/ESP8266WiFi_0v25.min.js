function t(a){return{ip:a.charCodeAt(0)+"."+a.charCodeAt(1)+"."+a.charCodeAt(2)+"."+a.charCodeAt(3),port:a.charCodeAt(5)<<8|a.charCodeAt(4),len:a.charCodeAt(7)<<8|a.charCodeAt(6)}}function u(a){var c=a.indexOf(":");if(0>c)return a;var b=a.substring(5,c).split(",");b[1]|=0;var f=a.length-(c+1),d=b[0];if(q[d]){var k=(b[2]||"0.0.0.0").split(".").map(function(a){return 0|a}),n=0|b[3];g[d]+=String.fromCharCode(k[0],k[1],k[2],k[3],n&255,n>>8,f&255,f>>8)}if(f>=b[1])return g[d]+=a.substr(c+1,
b[1]),a.substr(c+b[1]+1);g[d]+=a.substr(c+1,f);e.getData(b[1]-f,function(a){g[d]+=a});return""}function l(a){d[a[0]]="Wait"==d[a[0]]?!0:"Accept"}function m(a){d[a[0]]=""!=g[a[0]]?"DataClose":void 0}var e,d=[],q=[],g=["","","","",""],r=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],v={create:function(a,c,b){if(!e)return-1;if(void 0===a&&2!=b)return f=5,d[f]="Wait",g[f]="",e.cmd("AT+CIPSERVER=1,"+c+"\r\n",1E4,function(a){"OK"==a?d[f]=!0:(d[f]=void 0,setTimeout(function(){throw Error("CIPSERVER failed ("+
(a?a:"Timeout")+")");},0))}),5;for(var f=0;void 0!==d[f];)f++;if(5<=f)return-7;g[f]="";d[f]="Wait";var h;2==b?(c?h="AT+CIPSTART="+f+',"UDP","255.255.255.255",'+c+","+c+",2\r\n":d[f]="UDP",q[f]=!0):(h="AT+CIPSTART="+f+',"TCP",'+JSON.stringify(a)+","+c+"\r\n",delete q[f]);h&&e.cmd(h,1E4,function(a){"OK"!=a&&(d[f]=-6)});return f},close:function(a){"Wait"==d[a]?d[a]="WaitClose":void 0!==d[a]&&(0>d[a]||"UDP"==d[a]?d[a]=void 0:e.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(){d[a]=void 0}))},
accept:function(){for(var a=0;5>a;a++)if("Accept"==d[a])return d[a]=!0,a;return-1},recv:function(a,c){if(g[a]){if(g[a].length>c){var b=g[a].substr(0,c);g[a]=g[a].substr(c)}else b=g[a],g[a]="","DataClose"==d[a]&&(d[a]=void 0);return b}return 0>d[a]?d[a]:d[a]?"":-1},send:function(a,c,b){if(!e)return-1;if(e.isBusy()||"Wait"==d[a])return 0;if(0>d[a])return d[a];if(!d[a])return-1;if("UDP"==d[a])return b=t(c),d[a]="Wait",e.cmd("AT+CIPSTART="+a+',"UDP","'+b.ip+'",'+b.port+","+b.port+",2\r\n",1E4,function(b){"OK"!=
b&&(d[a]=-6)}),0;var f=c.length,h="";2==b&&(b=t(c),h=',"'+b.ip+'",'+b.port,c=c.substr(8,b.len),f=8+b.len);e.cmd("AT+CIPSEND="+a+","+c.length+h+"\r\n",1E4,function w(b){if("OK"==b)e.register("> ",function(a){e.unregister("> ");e.write(c);return a.substr(2)});else if(b!="Recv "+c.length+" bytes"&&"busy s..."!=b){"SEND OK"==b?("WaitClose"==d[a]&&v.close(a),d[a]=!0):(d[a]=void 0,e.unregister("> "));return}return w});d[a]="Wait";return f}},p={ipdHandler:u,debug:function(){return{socks:d,sockData:g}},init:function(a){e.cmd("ATE0\r\n",
1E3,function f(b){if("ATE0"==b)return f;"OK"==b?e.cmd("AT+CIPMUX=1\r\n",1E3,function(b){"OK"!=b?a("CIPMUX failed: "+(b?b:"Timeout")):e.cmd("AT+CIPDINFO=1\r\n",1E3,function(){a(null)})}):a("ATE0 failed: "+(b?b:"Timeout"))})},reset:function(a){e.cmd("\r\nAT+RST\r\n",1E4,function f(b){if("ready"==b||"Ready."==b)setTimeout(function(){p.init(a)},1E3);else if(void 0===b)a("No 'ready' after AT+RST");else return f})},getVersion:function(a){e.cmd("AT+GMR\r\n",1E3,function(c){a(null,c)})},connect:function(a,
c,b){e.cmd("AT+CWMODE=1\r\n",1E3,function(f){"no change"!=f&&"OK"!=f?b("CWMODE failed: "+(f?f:"Timeout")):e.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(c)+"\r\n",2E4,function n(a){if(0<=["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(a))return n;"OK"!=a?setTimeout(b,0,"WiFi connect failed: "+(a?a:"Timeout")):setTimeout(b,0,null)})})},getAPs:function(a){var c=[];e.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");c.push({ssid:JSON.parse(a[1]),
enc:r[a[0]],signal:parseInt(a[2]),mac:JSON.parse(a[3])})},function(){a(null,c)})},getConnectedAP:function(a){var c;e.cmdReg("AT+CWJAP?\r\n",1E3,"+CWJAP:",function(a){c=JSON.parse(a.slice(7))},function(){a(null,c)})},createAP:function(a,c,b,f,d){e.cmd("AT+CWMODE=2\r\n",1E3,function(g){"no change"!=g&&"OK"!=g&&"WIFI DISCONNECT"!=g&&d("CWMODE failed: "+(g?g:"Timeout"));g=f?r.indexOf(f):0;0>g?d("Encryption type "+f+" not known - "+r):e.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(c)+","+b+","+
g+"\r\n",5E3,function(a){"OK"!=a?d("CWSAP failed: "+(a?a:"Timeout")):d(null)})})},getConnectedDevices:function(a){var d=[];this.at.cmd("AT+CWLIF\r\n",1E3,function h(c){if("OK"==c)a(null,d);else if(void 0===c||"ERROR"==c)a("Error");else return c=c.split(","),d.push({ip:c[0],mac:c[1]}),h})},getIP:function(a){var c;e.cmdReg("AT+CIFSR\r\n",1E3,"+CIFSR",function(a){!c&&0<=a.indexOf(",")&&(c=JSON.parse(a.slice(a.indexOf(",")+1)))},function(b){"OK"!=b?a("CIFSR failed: "+b):a(null,c)})},setHostname:function(a,
c){e.cmd("AT+CWHOSTNAME="+JSON.stringify(a)+"\r\n",500,c)},ping:function(a,c){var b;e.cmd('AT+PING="'+a+'"\r\n',1E3,function k(a){if(a&&"+"==a[0])return b=a.substr(1),k;"OK"==a?c(b):c()})}};exports.connect=function(a,c){p.at=e=require("AT").connect(a);require("NetworkJS").create(v);e.register("+IPD",u);e.registerLine("0,CONNECT",l);e.registerLine("1,CONNECT",l);e.registerLine("2,CONNECT",l);e.registerLine("3,CONNECT",l);e.registerLine("4,CONNECT",l);e.registerLine("0,CLOSED",m);e.registerLine("1,CLOSED",
m);e.registerLine("2,CLOSED",m);e.registerLine("3,CLOSED",m);e.registerLine("4,CLOSED",m);e.registerLine("WIFI CONNECTED",function(){exports.emit("associated")});e.registerLine("WIFI GOT IP",function(){exports.emit("connected")});e.registerLine("WIFI DISCONNECTED",function(){exports.emit("disconnected")});p.reset(c);return p}