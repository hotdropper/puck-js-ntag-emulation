function d(c,b){this.flash=b?b:require("Flash");if(c)this.addr=c;else if(void 0!==this.flash.getFree){var a=this.flash.getFree();if(a.length)this.addr=a[0].addr;else throw"No free flash memory found";}else{a=process.memory();if(!a.flash_start||!a.flash_length)throw"process.memory() didn't contain information about flash memory";this.addr=a.flash_start+a.flash_length}a=this.flash.getPage(this.addr);if(!a)throw"Couldn't find flash page";this.addr=a.addr;this.endAddr=a.addr+a.length}d.prototype.getAddr=
function(c){for(var b=this.addr,a=this.flash.read(4,b),d=-1;255!=a[3]&&b<this.endAddr;)a[0]==c&&(d=b),b+=(a[1]|a[2]<<8)+7&-4,a=this.flash.read(4,b);return{addr:d,end:b}};d.prototype.read=function(c){c=this.getAddr(c).addr;if(!(0>c)){var b=this.flash.read(4,c);return this.flash.read(b[1]|b[2]<<8,c+4)}};d.prototype.readMem=function(c){c=this.getAddr(c).addr;if(!(0>c)){var b=this.flash.read(4,c);return E.memoryArea(c+4,b[1]|b[2]<<8)}};d.prototype.readAll=function(){for(var c=[],b=this.addr,a=this.flash.read(4,
b);255!=a[3]&&b<this.endAddr;){var d=a[1]|a[2]<<8;d&&(c[a[0]]=this.flash.read(d,b+4));b+=d+7&-4;a=this.flash.read(4,b)}return c};d.prototype._write=function(c,b,a){this.flash.write(new Uint8Array([b,a.length,a.length>>8,0]),c);c+=4;a.length&3&&(b=new Uint8Array(a.length+3&-4),b.set(a),a=b);a.length&&this.flash.write(a,c);return c+a.length};d.prototype.write=function(c,b){b=E.toUint8Array(b);var a=this.getAddr(c);if(0<=a.addr){var d=this.flash.read(4,a.addr);if(this.flash.read(d[1]|d[2]<<8,a.addr+
4)==b)return}if(a.end+b.length+4>=this.endAddr&&(a.end=this.cleanup(),a.end+b.length+4>=this.endAddr))throw"Not enough memory!";this._write(a.end,c,b)};d.prototype.cleanup=function(){var c=this.readAll();this.flash.erasePage(this.addr);var b=this.addr,a;for(a in c)void 0!==c[a]&&(b=this._write(b,a,c[a]));return b};d.prototype.erase=function(){this.flash.erasePage(this.addr)};exports=d