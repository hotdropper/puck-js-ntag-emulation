function m(a){var e=a.indexOf(":\r\n");if(0>e)return a;var b=a.substring(9,e).split(",");b[1]|=0;var d=a.length-(e+3);if(d>=b[1])return f[b[0]]+=a.substr(e+3,b[1]),a.substr(e+b[1]+3);f[b[0]]+=a.substr(e+3,d);c.getData(b[1]-d,function(a){f[b[0]]+=a});return""}function n(a){var e=a.indexOf(":");if(0>e)return a;var b=a.substring(3,e).split(",");b[1]|=0;var d=a.length-(e+1);if(d>=b[1])return f[b[0]]+=a.substr(e+1,b[1]),a.substr(e+b[1]+1);f[b[0]]+=a.substr(e+1,d);c.getData(b[1]-d,function(a){f[b[0]]+=
a});return""}var c,g=[],f=["","","","",""],l,h=!1,p={create:function(a,e){if(void 0===a){var b=5;g[b]="Wait";f[b]="";c.cmd("AT+CIPSERVER=1,"+e+"\r\n",1E4,function(a){if("OK"==a)g[b]=!0;else throw g[b]=void 0,Error("CIPSERVER failed");});return 5}for(b=0;void 0!==g[b];)b++;if(5<=b)throw Error("No free sockets.");g[b]="Wait";f[b]="";c.cmd("AT+CIPSTART="+b+',"TCP",'+JSON.stringify(a)+","+e+"\r\n",1E4,function(a){if("OK"==a)c.registerLine(b+", CONNECT OK",function(){c.unregisterLine(b+", CONNECT OK");
c.unregisterLine(b+", CONNECT FAIL");g[b]=!0;return""}),c.registerLine(b+", CONNECT FAIL",function(){c.unregisterLine(b+", CONNECT FAIL");c.unregisterLine(b+", CONNECT OK");c.unregisterLine(b+", CLOSED");g[b]=void 0;return""}),c.registerLine(b+", CLOSED",function(){c.unregisterLine(b+", CLOSED");var a=b;c.unregister(">");c.unregisterLine(a+", SEND OK");c.unregisterLine(a+", SEND FAIL");g[b]=void 0;h=!1;return""});else return g[b]=void 0,""});return b},close:function(a){g[a]&&c.cmd("AT+CIPCLOSE="+
a+",1\r\n",1E3,function(){g[a]=void 0})},accept:function(){for(var a=0;5>a;a++)if(f[a]&&void 0===g[a])return g[a]=!0,a;return-1},recv:function(a,c){if(f[a]){if(f[a].length>c){var b=f[a].substr(0,c);f[a]=f[a].substr(c)}else b=f[a],f[a]="";return b}return g[a]?"":-1},send:function(a,e){if(h||c.isBusy()||"Wait"==g[a])return 0;if(!g[a])return-1;h=!0;c.register(">",function(){c.unregister(">");c.write(e);return""});c.registerLine(a+", SEND OK",function(){c.unregisterLine(a+", SEND OK");c.unregisterLine(a+
", SEND FAIL");h=!1;return""});c.registerLine(a+", SEND FAIL",function(){c.unregisterLine(a+", SEND OK");c.unregisterLine(a+", SEND FAIL");h=!1;return-1});c.write("AT+CIPSEND="+a+","+e.length+"\r\n");return e.length}},k={debug:function(){return{socks:g,sockData:f}},init:function(a){var e=0,b=function(d){switch(e){case 0:if("IIIIATE0"===d||d==="IIII"+String.fromCharCode(255)+"ATE0"||"ATE0"===d)return b;"OK"===d?(e=1,c.cmd("AT+CPIN?\r\n",1E3,b)):d&&a("Error in ATE0: "+d);break;case 1:if("+CPIN: READY"===
d)return b;"OK"===d?(e=2,c.cmd("AT+CGATT=1\r\n",1E3,b)):d&&a("Error in CPIN: "+d);break;case 2:"OK"===d?(e=3,c.cmd("AT+CIPSHUT\r\n",1E3,b)):d&&a("Error in CGATT: "+d);break;case 3:"SHUT OK"===d?(e=4,c.cmd("AT+CIPSTATUS\r\n",1E3,b)):d&&a("Error in CIPSHUT: "+d);break;case 4:if("OK"===d)return b;"STATE: IP INITIAL"===d?(e=5,c.cmd("AT+CIPMUX=1\r\n",1E3,b)):d&&a("Error in CIPSTATUS: "+d);break;case 5:if(d&&"C: "==d.substr(0,3))return b;"OK"===d?(e=6,c.cmd("AT+CIPHEAD=1\r\n",1E3,b)):d&&a("Error in CIPMUX: "+
d);break;case 6:if("OK"===d)return b;d?a("Error in CIPHEAD: "+d):a(null)}};c.cmd("ATE0\r\n",3E3,b)},reset:function(a){if(!l)return k.init(a);digitalPulse(l,!1,200);setTimeout(function(){k.init(a)},15E3)},getVersion:function(a){c.cmd("AT+GMR\r\n",1E3,function(c){a(null,c)})},connect:function(a,e,b,d){var f=0,g=function(a){switch(f){case 0:"OK"===a?(f=1,c.cmd("AT+CIICR\r\n",2E3,g)):a&&d("Error in "+f+": "+a);break;case 1:if("OK"===a)return g;a?d("Error in "+f+": "+a):d(null)}};c.cmd('AT+CSTT="'+a+'", "'+
e+'", "'+b+'"\r\n',1E3,g)},getIP:function(a){var e,b=function(c){if(c&&"ERROR"!=c&&"OK"!=c)return e=c,b;"ERROR"===c?a("CIFSR Error"):c||a(null,e)};c.cmd("AT+CIFSR\r\n",2E3,b)}};exports.connect=function(a,e,b){l=e;k.at=c=require("AT").connect(a);require("NetworkJS").create(p);c.register("+RECEIVE",m);c.register("+D",n);k.reset(b);return k}