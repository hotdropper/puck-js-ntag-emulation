function c(a,b){this.i2c=a;this.ad=41;this.saved_vhv_timeout=this.saved_vhv_init=this.osc_calibrate_val=this.fast_osc_frequency=0;this.rangingData={};this.results={};this.calibrated=!1;b?(b.distanceMode||(b.distanceMode="long"),b.timingBudget||(b.timingBudget="long"===b.distanceMode&&14E4||5E4),void 0===b.interMeasurementPeriod&&(b.interMeasurementPeriod=b.timingBudget/1E3),b.enable2V8Mode=!!b.enable2V8Mode):b={distanceMode:"long",timingBudget:14E4,enable2V8Mode:!1,interMeasurementPeriod:200};
this.init(b)}c.prototype.r16=function(a){this.i2c.writeTo(this.ad,a>>8,a&255);a=this.i2c.readFrom(this.ad,2);return a[0]<<8|a[1]};c.prototype.r=function(a,b){this.i2c.writeTo(this.ad,a>>8,a&255);return this.i2c.readFrom(this.ad,b)};c.prototype.r8=function(a){this.i2c.writeTo(this.ad,a>>8,a&255);return this.i2c.readFrom(this.ad,1)[0]};c.prototype.w8=function(a,b){this.i2c.writeTo(this.ad,a>>8,a&255,b)};c.prototype.w16=function(a,b){this.i2c.writeTo(this.ad,a>>8,a&255,b>>8,b&255)};c.prototype.w32=function(a,
b){this.i2c.writeTo(this.ad,a>>8,a&255,b>>24,b>>16,b>>8,b&255)};c.prototype.delayMicroseconds=function(a){for(a=getTime()+a/1E6;getTime()<a;);};c.prototype.init=function(a){if(60108!=this.r16(271))throw Error("Model ID not recognized");this.w8(0,0);this.delayMicroseconds(100);this.w8(0,1);for(this.delayMicroseconds(1E3);0==(this.r8(229)&1););a.enable2V8Mode&&this.w8(46,this.r8(46)|1);console.log("[VL53L1X] IO 2V8 Mode  = '"+a.enable2V8Mode+"'");this.fast_osc_frequency=this.r16(6);this.osc_calibrate_val=
this.r16(222);this.w16(36,2560);this.w8(49,2);this.w8(54,8);this.w8(55,16);this.w8(57,1);this.w8(62,255);this.w8(63,0);this.w8(64,2);this.w16(80,0);this.w16(82,0);this.w8(87,56);this.w16(100,360);this.w16(102,192);this.w8(113,1);this.w8(124,1);this.w8(126,2);this.w8(130,0);this.w8(119,1);this.w8(129,139);this.w16(84,51200);this.w8(79,2);this.setMeasurementTimingBudget(a.timingBudget);this.setDistanceMode(a.distanceMode);this.w16(30,4*this.r16(34));0<a.interMeasurementPeriod&&this.startContinuous(a.interMeasurementPeriod)};
c.prototype.calcMacroPeriod=function(a){var b=1073741824/this.fast_osc_frequency*2304>>6;return b=b*(a+1<<1)>>6};c.prototype.timeoutMicrosecondsToMclks=function(a,b){return((a<<12)+(b>>1))/b};c.prototype.encodeTimeout=function(a){var b=0;if(0<a){for(--a;0<(a&4294967040);)a>>=1,b++;return b<<8|a&255}return 0};c.prototype.setMeasurementTimingBudget=function(a){if(4528>=a)throw Error("timingBudget '"+a+"us' too low");var b=a-=4528;if(11E5<b)throw Error("timingBudget '"+a+"us' too high");b/=2;var c=this.calcMacroPeriod(this.r8(96));
var d=this.timeoutMicrosecondsToMclks(1E3,c);255<d&&(d=255);this.w8(75,d);this.w16(90,this.encodeTimeout(this.timeoutMicrosecondsToMclks(1,c)));this.w16(94,this.encodeTimeout(this.timeoutMicrosecondsToMclks(b,c)));c=this.calcMacroPeriod(this.r8(99));this.w16(92,this.encodeTimeout(this.timeoutMicrosecondsToMclks(1,c)));this.w16(97,this.encodeTimeout(this.timeoutMicrosecondsToMclks(b,c)));console.log("[VL53L1X] Setting timingBudget = '"+a+"us'")};c.prototype.setDistanceMode=function(a){var b=this.getMeasurementTimingBudget();
console.log("[VL53L1X] timingBudget is set to '"+b+"us'");switch(a){case "short":var c=[7,5,56];var d=[7,5,6,6];break;case "medium":c=[11,9,120];d=[11,9,10,10];break;case "long":c=[15,13,184];d=[15,13,14,14];break;default:throw Error("[VL53L1X] Unknown distanceMode ("+a+")");}console.log("[VL53L1X] distanceMode = '"+a+"'");this.w8(96,c[0]);this.w8(99,c[1]);this.w8(105,c[2]);this.w8(120,d[0]);this.w8(121,d[1]);this.w8(122,d[2]);this.w8(123,d[3]);this.setMeasurementTimingBudget(b);distance_mode=a;return!0};
c.prototype.startContinuous=function(a){this.w32(108,a*this.osc_calibrate_val);this.w8(134,1);this.w8(135,64);console.log("[VL53L1X] continuous measurements started")};c.prototype.stopContinuous=function(){this.w8(135,128);this.calibrated=!1;0!=this.saved_vhv_init&&this.w8(11,this.saved_vhv_init);0!=this.saved_vhv_timeout&&this.w8(8,this.saved_vhv_timeout);this.w8(77,0)};c.prototype.setupManualCalibration=function(){this.saved_vhv_init=this.r8(11);this.saved_vhv_timeout=this.r8(8);this.w8(11,this.saved_vhv_init&
127);this.w8(8,(this.saved_vhv_timeout&3)+12);this.w8(77,1);this.w8(71,this.r8(216))};c.prototype.updateDSS=function(){var a=this.results.dss_actual_effective_spads_sd0;if(a){var b=this.results.peak_signal_count_rate_crosstalk_corrected_mcps_sd0+this.results.ambient_count_rate_mcps_sd0;65535<b&&(b=65535);a=167772160/((b<<16)/a);65535<a&&(a=65535);a?this.w16(84,a&65535):(console.log("[VL53L1X] Warning: requiredSpads == 0"),this.w16(84,32768))}else console.log("[VL53L1X] Warning: spadCount == 0"),this.w16(84,
32768)};c.prototype.getDistance=function(){return Math.round(2011*this.results.final_crosstalk_corrected_range_mm_sd0/2048)};c.prototype.getRangingData=function(){var a=this.getDistance();switch(this.results.rangeStatus){case 17:case 2:case 1:case 3:var b="HardwareFail";break;case 13:b="MinRangeFail";break;case 18:b="SynchronizationInt";break;case 5:b="OutOfBoundsFail";break;case 4:b="SignalFail";break;case 6:b="SignalFail";break;case 7:b="WrapTargetFail";break;case 12:b="XtalkSignalFail";break;case 8:b=
"RangeValidMinRangeClipped";break;case 9:b=0==this.results.stream_count?"RangeValidNoWrapCheckFail":"RangeValid";break;default:b="None"}return{status:b,distance:a,signalRate:this.results.peak_signal_count_rate_crosstalk_corrected_mcps_sd0/128,ambientRate:this.results.ambient_count_rate_mcps_sd0/128,effectiveSpadRtnCount:this.results.dss_actual_effective_spads_sd0/256}};c.prototype.readResults=function(){for(;0!==(this.r8(49)&1););var a=new DataView(this.r(137,17).buffer);this.results.rangeStatus=
a.getInt8(0);this.results.stream_count=a.getInt8(2);this.results.dss_actual_effective_spads_sd0=a.getUint16(3);this.results.ambient_count_rate_mcps_sd0=a.getUint16(7);this.results.final_crosstalk_corrected_range_mm_sd0=a.getUint16(13);this.results.peak_signal_count_rate_crosstalk_corrected_mcps_sd0=a.getUint16(15)};c.prototype.getMeasurementTimingBudget=function(){var a=this.calcMacroPeriod(this.r8(96));return 2*this.timeoutMclksToMicroseconds(this.decodeTimeout(this.r16(94)),a)+4528};c.prototype.timeoutMclksToMicroseconds=
function(a,b){return a*b+2048>>12};c.prototype.decodeTimeout=function(a){return((a&255)<<(a>>8))+1};c.prototype.read=function(){this.readResults();this.calibrated||(this.setupManualCalibration(),this.calibrated=!0);this.updateDSS();this.w8(134,1)};c.prototype.readMeasurement=function(){this.read();return this.getRangingData()};c.prototype.readDistance=function(){this.read();return this.getDistance()};c.prototype.performSingleMeasurement=c.prototype.readMeasurement;exports.connect=function(a,b){return new c(a,
b)}