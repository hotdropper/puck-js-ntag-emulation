function h(a){a=a||{};this.port=a.port||80;this.type=a.default_type||"text/plain";this.index=a.default_index||"index.html";this.not_found=a.default_not_found||"File not found";this.file_system=a.file_system||"";this.memory=a.memory||null}String.prototype.byteLength=function(){for(var a=0,c=8*Math.LN2,b=0;b<this.length;b++)a+=Math.ceil(Math.log(this[b].charCodeAt())/c);return a};h.prototype.router=function(a,c){var b=url.parse(a.url,!0),g=b.pathname.lastIndexOf("/"),d={status:200,"Content-Type":this.type},
f="";0<=g&&(b.file=b.pathname.substr(g+1)||this.index,b.isSsS=b.file.toLowerCase().indexOf(".njs"));this.emit("request",a,c,b,this);try{switch(a.method){case "TRACE":d["Content-Type"]="message/http";f=this.getTrace(a);break;default:var e=this.memory&&this.memory[b.file]?this.memory[b.file]:this.file_system?this.getDiskFile(this.file_system+b.pathname):null;e&&(0<b.isSsS&&("object"==typeof e.content&&(e=this.evalFile(e.content)),"function"==typeof e.content&&(e=e.content(a,c,b,this))),e.content&&(f=
e.content,e.header?d=e.header:e.type&&(d["Content-Type"]=e.type)));f||(d.status=404,d["Content-Type"]=this.type,f=this.not_found);"HEAD"==a.method&&(f="")}}catch(k){this.emit("error",k,this),d.status=500,d["Content-Type"]=this.type,f=k.type+" on "+b.file+": "+k.msg}!d["Content-Length"]&&f.byteLength&&(d["Content-Length"]=f.byteLength());this.serveContent(c,d,f)};h.prototype.evalFile=function(a){var c=txt="",b;try{for(;c=a.read(8);)txt+=c;a.close();b=eval(txt)()}catch(g){this.emit("error",g,this)}return b};
h.prototype.serveContent=function(a,c,b){a.writeHead(c.status,c);try{"string"==typeof b?a.end(b):b.pipe?b.pipe(a,{complete:function(){b.close();b=null}}):a.end("")}catch(g){this.emit("error",g,this)}};h.prototype.getDiskFile=function(a){var c,b,g,d;try{"undefined"!=(c=E.openFile(a,"r"))&&("undefined"!=(b=E.openFile(a+".type","r"))&&(d=b.read(55),b.close()),g=c)}catch(f){this.emit("error",f,this)}return{content:g,type:d}};h.prototype.createServer=function(){try{this.server=require("http").createServer(this.router.bind(this)),
this.server.listen(this.port),this.emit("start",this)}catch(a){this.emit("error",a,this)}};h.prototype.getTrace=function(a){var c;c='"status": "200"\n'+('"method": "'+a.method+'"\n');c+='"url": "'+a.url+'"\n';for(var b in a.headers)c+='"'+b+'": "'+a.headers[b]+'"\n';return c};module.exports=h