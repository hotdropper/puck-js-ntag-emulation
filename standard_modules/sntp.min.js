function l(a,d){var b=a.host||"pool.ntp.org",p=a.port||123,c=a.timeout||1E3,u=a.parser||t,m=0,n=0,f=!1,k=function(a,b){f||(f=!0,m&&(clearTimeout(m),m=0),h.removeAllListeners(),h.on("error",q),h.close(),d(a?Error(a):null,b))},h=v.createSocket("udp4");h.on("error",k);h.on("message",function(a){a=E.toArrayBuffer(a);var d=Date.now(),b=u(a);if(!b)return k("ISR",{buffer:a});if(b.T1!==n)return k("WOT",b);a=b.T1;var c=b.T2,e=b.T3;d=b.T4=d;b.d=d-a-(e-c);b.t=(c-a+(e-d))/2;k(null,b)});c&&(m=setTimeout(function(){m=
0;k("Timeout")},c));c=new Uint8Array(48);var l=new DataView(c.buffer);c[0]=35;n=Date.now();w(n,l,40);n=g(l,40);h.send(E.toString(c),p,b,function(a,b){(a||48!==b)&&k(a||"CNS")})}function t(a){if(48===a.length){var b=(a[0]&56)>>3,e=a[0]&7,p=a[1],c=new DataView(a);a=g(c,24);var f=g(c,32);c=g(c,40);if(4===b&&15>=p&&4===e&&a&&f&&c)return{T1:a,T2:f,T3:c}}}function g(a,b){var d=a.getUint32(b),f=a.getUint32(b+4);return 1E3*(d-2208988800+f/Math.pow(2,32))}function w(a,b,e){var d=Math.round(a%1E3/1E3*Math.pow(2,
32));b.setUint32(e,Math.floor(a/1E3)+2208988800);b.setUint32(e+4,d)}function f(a,d){var e=Date.now(),f=a.clockSyncRefresh||864E5;b.last.offset&&b.last.host===a.host&&b.last.port===a.port&&e<b.last.expires?setTimeout(function(){return d(null,b.last.offset)}):l(a,function(c,g){if(c)return d(c,0);b.last={offset:Math.round(g.t),expires:e+f,host:a.host,port:a.port};return d(null,b.last.offset)})}function r(){return!!b.now.intervalId}var v=require("dgram"),b={},q=function(){},x=function(a){var b=new DataView(a);
this.isValid=!1;if(48===a.length){switch(a[0]>>6){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}this.version=(a[0]&56)>>3;switch(a[0]&7){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var e=a[1];
this.stratum=0===e?"death":1===e?"primary":15>=e?"secondary":"reserved";this.pollInterval=1E3*Math.round(Math.pow(2,a[2]));this.precision=1E3*Math.pow(2,a[3]);this.rootDelay=1E3*(b.getUint32(4)/65536);this.rootDispersion=1E3*(b.getUint32(8)/65536);this.referenceId="";switch(this.stratum){case "death":case "primary":this.referenceId=String.fromCharCode(a[12])+String.fromCharCode(a[13])+String.fromCharCode(a[14])+String.fromCharCode(a[15]);break;case "secondary":this.referenceId=""+a[12]+"."+a[13]+
"."+a[14]+"."+a[15]}this.referenceTimestamp=g(b,16);this.originateTimestamp=g(b,24);this.receiveTimestamp=g(b,32);this.transmitTimestamp=g(b,40);4===this.version&&"reserved"!==this.stratum&&"server"===this.mode&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0);return this}};b.last={offset:0,expires:0,host:"",port:0};b.now={intervalId:0};exports.errors={ISR:"Invalid server response",WOT:"Wrong originate timestamp != sent timestamp",CNS:"Could not send entire message",
Timeout:"Timeout receiving response"};exports.parseVerbose=function(a){a=new x(a);if(a.isValid)return a.T1=a.originateTimestamp,a.T2=a.receiveTimestamp,a.T3=a.transmitTimestamp,a};exports.time=l;exports.offset=f;exports.start=function(a,d){b.now.intervalId?setTimeout(d):f(a,function(){b.now.intervalId=setInterval(function(){f(a,q)},a.clockSyncRefresh||864E5);return d()})};exports.stop=function(){b.now.intervalId&&(clearInterval(b.now.intervalId),b.now.intervalId=0)};exports.isLive=r;exports.now=function(){var a=
Date.now();return!r()||a>=b.last.expires?a:a+b.last.offset}